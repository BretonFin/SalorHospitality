- form_for :order, order, :url => table_order_path(order.table_id, order), :html => { :method => :put } do |order_form|

  %input#print_invoice{ :name => 'print', :type => 'image', :src => '/images/button_print.png', :title => 'Drucken' }
  %input#storno_item{ :name => 'storno', :type => 'image', :src => '/images/button_cancel.png', :title => 'Storno' }
  %a#go_back{ :href => '#', :onclick => "history.back(); return false;", :title => 'ZurÃ¼ck' }
    %img{ :src => '/images/button_back.png' }
  
  %h3== #{ t :order, :count => 1} ##{order.id}
  %p= l order.created_at, :format => :long
  
  %table{ :class => 'invoice' }
    %tr
      %th{ :style => 'width:20px; text-align:right' }
      %th{ :style => 'width:150px' }
      %th{ :style => 'width:70px' }
      %th{ :style => 'width:70px' }
    - subtotal = 0
    - order_form.fields_for :items do |item_form|
      - item = item_form.object
      - c = item.count
      - p = item.quantity_id ? item.quantity.price : item.article.price
      - p = -p if item.storno_status == 2
      - sum = 0
      - sum = c * p
      - subtotal += sum
      - itemnumber = /order\[items_attributes\]\[(.*)\]/.match(item_form.object_name)[1]
      - color = item.storno_status == 2 ? '#FAA' : 'transparent'
      - storno_enabled = (item.storno_status.nil? or item.storno_status.zero?)
      - onclick_action = storno_enabled ? "mark_item_for_storno(this, #{order_form.object.id}, #{itemnumber})" : ''
      %tr.simple_invoice{ :id => "item#{item.id}", :onclick => onclick_action, :style => "background-color: #{color}" }
        %td= c
        - label = item.quantity_id ? "#{ item.quantity.article.name} #{ item.quantity.name}" : item.article.name
        %td= "%20.20s" % [label]
        %td{ :style => 'text-align:right' }= number_to_currency p
        %td{ :style => 'text-align:right' }= number_to_currency sum
        - if storno_enabled
          %input{ :id => "order_items_attributes_#{order_form.object.id}_#{itemnumber}_storno_status", :name => "order[items_attributes][#{itemnumber}][storno_status]", :type => "hidden"} 

    %tr
      %td{ :colspan => '3'}
      %td{ :style => 'text-align:right'}
        %b= number_to_currency subtotal
