%div.invoice{ :id => "invoice_#{invoice_form.id}" }

  = link_to_remote '', :url => "/orders/print_and_finish/#{ invoice_form.id }/0", :html => { :class => 'iconbutton print_kitchen_button', :title => t(:print) }
  = link_to_remote '', :url => "/orders/print_and_finish/#{ invoice_form.id }/1", :html => { :class => 'iconbutton print_bar_button', :title => t(:print) }
  = link_to_remote '', :url => "/orders/print_and_finish/#{ invoice_form.id }/2", :html => { :class => 'iconbutton print_guestroom_button', :title => t(:print) }
  = link_to_remote '', :url => "/orders/print_and_finish/#{ invoice_form.id }/3", :html => { :class => 'iconbutton finish_button', :title => t(:print) }


  - remote_form_for :order, invoice_form, :url => { :controller => :orders, :action => :update, :id => invoice_form.id }, :html => { :method => 'put', :id => "invoice_form_#{ invoice_form.id }" } do |order_form|

    %select#cost_center_for_invoice{ :onchange => "new Ajax.Request('/orders/split_invoice_all_at_once/#{ invoice_form.id }', {asynchronous:true, evalScripts:true, parameters:Form.serialize('invoice_form_#{ invoice_form.id }')}); return false;", :name => 'order[cost_center_id]', :title => t('.split_invoice') }
      = options_from_collection_for_select(@cost_centers, :id, :name, (invoice_form.cost_center.id if invoice_form.cost_center))
    - if !invoice_form.finished
      = link_to_remote '', :url => "/orders/go_to_order_form/#{ invoice_form.id }", :html => { :class => 'iconbutton order_button', :title => t(:edit) }

    %h3== #{ t('activerecord.models.order.one')} ##{invoice_form.id}, #{ invoice_form.table.name }
    %p= l invoice_form.created_at, :format => :long
    %table{ :class => 'invoice' }
      - subtotal = 0
      - order_form.fields_for :items do |item_form|
        - item = item_form.object
        - sum = item.count * item.real_price
        - subtotal += sum
        - itemnumber = /order\[items_attributes\]\[(.*)\]/.match(item_form.object_name)[1]
        %tr.item{ :id => "order_#{invoice_form.id}_item_#{item.id}" }
          %td.count= link_to_remote(item.count, :url => { :controller => :orders, :action => :split_invoice_one_at_a_time, :id => item.id }, :submit => "invoice_form_#{ invoice_form.id }")
          - article_label = item.article.name[0..13]
          - prefix_label = item.quantity.prefix[0..9] if item.quantity and item.quantity.prefix
          - postfix_label = item.quantity.postfix[0..9] if item.quantity and item.quantity.postfix
          %td.label{ :id => "item#{item.id}"}= link_to_remote("#{ prefix_label } #{ article_label } #{ item.comment }<br>#{ postfix_label }", :url => { :controller => :orders, :action => :split_invoice_one_at_a_time, :id => item.id }, :submit => "invoice_form_#{ invoice_form.id }")
          %td.price= number_to_currency item.real_price
          %td.total= number_to_currency sum
          %input{ :id => "order_items_attributes_#{order_form.object.id}_#{itemnumber}_partial_order", :name => "order[items_attributes][#{itemnumber}][partial_order]", :type => "hidden"}

      %tr
        %td{ :colspan => '3'}
        %td{ :style => 'text-align:right'}
          %b= number_to_currency subtotal
