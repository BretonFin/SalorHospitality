- cost_center_header_text = "(#{ CostCenter.model_name.human }: #{@selected_cost_center.name})" if @selected_cost_center
%h2== #{ t 'activerecord.models.settlement.other' } #{ cost_center_header_text }

= form_tag settlements_path, :method => :get do
  = label('from', t('.start_date'))
  = select_date(@from, :prefix => 'from')
  = label('to', t('.end_date'))
  = select_date(@to, :prefix => 'to')
  = label('cc', CostCenter.model_name.human)
  %select{ :name => 'cost_center_id' }
    %option{ :value => '' }= t '.all_cost_centers'
    = options_from_collection_for_select(@cost_centers, :id, :name)
  = submit_tag t(:display)

%table{ :class => 'settlements' }
  %tr
    %th{ :class => 'bb', :style => 'width:40px' }
    %th{ :class => 'bb' }= t :dateandtime
    %th{ :class => 'br bb' }= User.model_name.human
    - @taxes.each do |tax|
      %th{ :class => 'bb', :style => 'width:90px' }== #{ tax.name }<br>#{ t :net }
    %th{ :class => 'br bb colsum', :style => 'width:100px' }== #{ t :sum }<br>#{ t :net }
    - @taxes.each do |tax|
      %th{ :class => 'bb', :style => 'width:90px' }== #{ tax.name }<br>#{t :gross} #{ number_to_percentage tax.percent, :precision => 0 }
    %th{ :class => 'br bb colsum', :style => 'width:100px' }== #{ t :sum }<br>#{ t :gross }

  - total_net = {}
  - total_gro = {}
  - @current_vendor.taxes.existing.each do |t|
    - total_net[t.id] = 0
    - total_gro[t.id] = 0

  - @settlements.each do |s|
    - s_net = {}
    - s_gro = {}
    - @current_vendor.taxes.existing.each do |t|
      - s_gro[t.id] = Item.find(:all, :conditions => { :hidden => nil, :refunded => nil, :vendor_id => @current_vendor, :refunded => nil, :tax_percent => t.percent, :settlement_id => s, :cost_center_id => @selected_cost_center, :created_at => @from..@to).sum(:sum)
      - s_net[t.id] = s_gro[t.id] - s.orders.existing.where(:cost_center_id => @selected_cost_center, :tax_id => t).sum(:tax_sum)
    - next if s_gro.to_a.sum { |g| g[1] } == 0
      
    %tr
      %td.link= link_to "##{s.id}", "settlements/detailed_list?settlement_id=#{ s.id }"
      %td= l s.created_at, :format => :date_iso
      %td{ :class => 'br' }= s.user.login
      - @taxes.each do |tax|
        %td= number_to_currency s_net[tax.id]
      %td{ :class => 'br colsum' }= number_to_currency s_net.to_a.sum { |n| n[1] }
      - @taxes.each do |tax|
        %td= number_to_currency s_gro[tax.id]
      %td{ :class => 'br colsum' }= number_to_currency s_gro.to_a.sum { |g| g[1] }

  %tr
    %th{ :colspan => 3, :class => 'br sum' }= t('.sum_total')
    - @taxes.each do |tax|
      %th{ :class => 'sum' }= number_to_currency total_net[tax.id]
    %th{ :class => 'sum colsum br' }= number_to_currency total_net.to_a.sum { |n| n[1] }
    - @taxes.each do |tax|
      %th{ :class => 'sum' }= number_to_currency total_gro[tax.id]
    %th{ :class => 'sum colsum br' }= number_to_currency total_gro.to_a.sum { |g| g[1] }
