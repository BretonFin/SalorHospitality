#!/bin/bash

instances=`debconf-show salor-hospitality | grep current-instances | sed 's/^.*: //'`

for instance in $instances; do

  echo ""
  echo "          $instance"
  echo "---------------------------------"
  
  app_root=/usr/share/salor-hospitality/$instance
  backupdir_database=/var/log/salor-hospitality/$instance
  backupdir_log=/var/log/salor-hospitality/$instance
  database_config_file=/etc/salor-hospitality/$instance/database.yml
  numversions=60
  d=$(date)

  # PRODUCTION LOG

  mkdir -p $backupdir_log

  cd $backupdir_log
  touch production.log # create this file if not yet present
  
  mv production.log 0-production.log
  touch production.log # create a new, empty log
  
  chmod 777 production.log
  gzip 0-production.log

  #cd $backupdir_log

  i=$numversions
  rm -rf $backupdir_log/$i-production.log.gz # remove the oldest log
  while [ $i -gt 0 ]; do
    mv $backupdir_log/`expr $i - 1`-production.log.gz 2> /dev/null $backupdir_log/$i-production.log.gz
    i=`expr $i - 1`
  done


  # DATABASE

  usernameline=`grep 'username:' $database_config_file | head -1`
  username=`echo $usernameline | sed -e 's/username: //'`
  databaseline=`grep 'database:' $database_config_file | head -1`
  database=`echo $databaseline | sed -e 's/database: //'`
  passwordline=`grep 'password:' $database_config_file | head -1`
  password=`echo $passwordline | sed -e 's/password: //'`

  echo "username is $username"
  echo "password is $password"
  echo "database is $database"

  # The most recent backup is called 0-database_name.sql.gz
  mkdir -p $backupdir_database
  cd $backupdir_database
  mysqldump --user $username --password=$password --opt $database > 0-$database.sql
  gzip 0-$database.sql

  # Rollover the backup directories
  i=$numversions
  rm -fr $backupdir_database/$i-$database.sql.gz  # delete the oldest dump
  while [ $i -gt 0 ]; do
    mv $backupdir_database/`expr $i - 1`-$database.sql.gz 2> /dev/null $backupdir_database/$i-$database.sql.gz
    i=`expr $i - 1`
  done

  mainuser=`debconf-show salor-hospitality | grep salor-hospitality/user | sed 's/^.*: //'`
  if [ -d /home/$mainuser ]; then
    cp ${backupdir_database}/1-$database.sql.gz /home/$mainuser/salor-hospitality-database.sql.gz
  fi
  chown $mainuser:$mainuser /home/$mainuser/salor-hospitality-database.sql.gz
  chmod 666 /home/$mainuser/salor-hospitality-database.sql.gz
done
exit 0
