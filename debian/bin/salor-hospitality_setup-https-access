#!/bin/bash
echo ""
echo "Testing for salor-hospitality SSL certificates for HTTPS access..."
if [ ! -f /etc/apache2/ssl/salor-hospitality.crt ]; then
  echo "salor-hospitality SSL certificates don't exist yet, creating them..."
  cd /root
  mkdir salor-hospitality_ssl_certificates
  cd salor-hospitality_ssl_certificates
  openssl req -new -newkey rsa:4096 -nodes -out salor-hospitality.csr -keyout salor-hospitality.key -subj "/C=AT/ST=/L=/O=SalorHospitality POS/CN=salor-hospitality"
  openssl req -x509 -days 6000 -in salor-hospitality.csr -key salor-hospitality.key -out salor-hospitality.crt
  chmod 600 salor-hospitality.*
  mkdir /etc/apache2/ssl
  cp salor-hospitality.key salor-hospitality.crt /etc/apache2/ssl
else
  echo "SALOR SSL certificates already exist."
fi


siteid=default
if [ "$1" = "" ]; then
  siteid=$1
fi

ln -sf /etc/apache2/sites-available/sh-$siteid-https /etc/apache2/sites-enabled/sh-$siteid-https

echo "The instance '$siteid' will now listen at port 443. By uncommenting the code in  /etc/apache2/sites-available/sh-$siteid-https, you can make the application securely listen on a second port (the default is 7652)."

# echo "Writing SSL port $1 to /etc/apache2/sites-available/salor-hospitality-ssl."
# sed -i -e "s/^Listen .*$/Listen $1/" /etc/apache2/sites-available/salor-hospitality-ssl
# sed -i -e "s/^<VirtualHost .*>$/<VirtualHost *:$1>/" /etc/apache2/sites-available/salor-hospitality-ssl

echo "Enabling Apache SSL module..."
a2enmod ssl
echo "Restarting Apache service..."
service apache2 restart