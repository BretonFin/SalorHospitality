#!/bin/bash -e

. /usr/share/debconf/confmodule

export RAILS_ENV=production
export PATH=$PATH:/opt/billgastro/bin

case $1 in
  upgrade)
    echo "postrm called with upgrade"
    # do something
  ;;
  remove)
    echo "postrm called with remove"
    # do something
  ;;
  purge)
    echo "postrm called with purge"

    echo "Backing up database."

    db_get billgastro/enter_username
    username=$RET
    echo "username is $username"
    db_get billgastro/enter_password
    password=$RET
    echo "password is $password"
    db_get billgastro/enter_database
    database=$RET
    echo "database is $database"

    cd /opt/billgastro/billgastro
    mysqldump -u $username -p$password $database > database-backup.sql

    echo "Dropping BillGastro database $database ..."
    mysql -u $username -p$password -Bse "drop database $database"
    db_purge
    exit 0
  ;;
  *)
    echo "postrm called with unknown argument '$1'" 1>&2
    exit 0
  ;;
esac
