#!/bin/sh

. /usr/share/debconf/confmodule

#echo "Stopping Apache Server ..."
#/etc/init.d/apache2 stop

echo "Reading configuration from Debconf database ..."
db_get billgastro/enter_username
username=$RET
db_get billgastro/enter_password
password=$RET
db_get billgastro/enter_database
database=$RET

echo "Setting username and password for BillGastro database ..."
cd /var/www/billgastro
cp config/database-default.yml config/database.yml
sed -i -e "s/username:.*/username: $username/" config/database.yml
sed -i -e "s/password:.*/password: $password/" config/database.yml
sed -i -e "s/database: .*/database: $database/" config/database.yml

echo "Changing behaviour of Exim E-Mail Server"
sed -i -e "s/dc_eximconfig_configtype=.*$/dc_eximconfig_configtype='internet'/" /etc/exim4/update-exim4.conf.conf

result=$(mysql -u $username -p$password -Bse 'show databases' | grep $database)

export RAILS_ENV=production
echo "Creating BillGastro database ..."
rake db:create
echo "Migrating BillGastro database ..."
rake db:migrate

if [ "$result" != "$database" ]
then
  echo "BillGastro database didn't exist before, so I'm populating it with seed data ..."
  rake db:fixtures:load
  db_input high billgastro/dataset || true
  db_go
  db_get billgastro/dataset
  if [ "$RET" = "false" ]
  then
    echo "User selected minimal dataset. Truncating all tables except 'users'."
    mysql -u $username -p$password $database -Bse "truncate table articles; truncate table quantities; truncate table items; truncate table orders; truncate table options; truncate table taxes; truncate table tables; truncate table categories; truncate table settlements; truncate table cost_centers;"
  fi
else
  echo "BillGastro database already exists, so I'm leaving it untouched ..."
fi

echo "Changing Permissions ..."
chown -R www-data:www-data /var/www/billgastro
chmod -R 755 /var/www/billgastro

echo "Modifying /etc/hosts ..."
echo "127.0.0.1 billgastro" >> /etc/hosts
echo "Restarting Apache ..."
service apache2 restart 0>/dev/null 1>/dev/null 2>/dev/null 3>/dev/null
echo "Restarting Exim4 ..."
service exim4 restart 0>/dev/null 1>/dev/null 2>/dev/null 3>/dev/null
#/etc/init.d/apache2 start ||true
#invoke-rc.d apache2 start ||true

db_input high billgastro/done || true
db_go
