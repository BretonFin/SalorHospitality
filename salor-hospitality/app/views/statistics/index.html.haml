%h2= t 'various.statistics'

= form_tag statistics_path, :method => :get do
  = submit_tag t(:display)
  = label 'from', t('settlements.index.start_date'), :class => 'right'
  = select_date(@from, :prefix => 'from', :order => [:year, :month, :day])
  = label 'to', t('settlements.index.end_date'), :class => 'right'
  = select_date(@to, :prefix => 'to', :order => [:year, :month, :day])
  - if @cost_centers.any?
    = label 'cc', CostCenter.model_name.human, :class => 'right'
    %select{ :name => 'cost_center_id', :onchange => '$("form").submit()' }
      %option{ :value => '' }= t ('settlements.index.all_cost_centers')
      - selected_id = @selected_cost_center ? @selected_cost_center.id.to_s : ''
      = options_from_collection_for_select(@cost_centers, :id, :name, selected_id)
      
- days = I18n.backend.send(:translations)[I18n.locale][:date][:day_names].rotate
%table.settlements.statistics
  %tr
    %th.bb{ :style => 'width:40px' }
    %th.bb
    %th.bb
  - i = 0
  - sums = []
  - days.each do |day|
    - sums[i] = Order.where(:settlement_id => @settlement_ids).where("WEEKDAY(finished_at) = #{i}").sum(:sum)
    - i += 1
  - maximum = sums.sort.last
  - i = 0
  - days.each do |day|
    %tr
      %td= day
      %td= number_to_currency sums[i]
      %td
        .statistics_bar{ :style => "width:#{sums[i]*100/maximum}px" }
    - i += 1
    
%table.settlements.statistics
  %tr
    %th.bb{ :style => 'width:40px' }
    %th.bb
    %th.bb
  - sums = []
  - 8.upto(23).each do |hour|
    - sums[hour] = Order.where(:settlement_id => @settlement_ids).where("HOUR(finished_at) = #{hour}").sum(:sum)
    - sums[hour] ||= 0
  - stripped_sums = sums.clone
  - stripped_sums.delete(nil)
  - maximum = stripped_sums.sort.last
  - 8.upto(23).each do |hour|
    %tr
      %td== #{hour}:00
      %td= number_to_currency sums[hour]
      %td
        .statistics_bar{ :style => "width:#{sums[hour]*100/maximum}px" }
      
%table.settlements.statistics
  %tr
    %th.bb{ :style => 'width:40px' }
    %th.bb
    %th.bb
  - sums = []
  - i = 0
  - @tables.each do |table|
    - sums[i] = Order.where(:settlement_id => @settlement_ids, :table_id => table).sum(:sum)
    - i += 1
  - maximum = sums.sort.last
  - i = 0
  - @tables.each do |table|
    %tr
      %td= table.name
      %td= number_to_currency sums[i]
      %td
        .statistics_bar{ :style => "width:#{sums[i]*100/maximum}px" }
    - i += 1
        
        
      
.clear